[{"name":"HTML5 drag drop for lists","code":"<script>\n  simply.dragdrop = {\n    getDataBinding : function(el) {\n      if (el.dataBinding) {\n        return el.dataBinding;\n      } else {\n        return el.querySelector(\"[data-simply-field]\").dataBinding; // FIXME: nested fields will go wrong this way;\n      }\n    },\n    getData : function(el) {\n      var dataBinding = simply.dragdrop.getDataBinding(el);\n      return dataBinding.config.data;\n    },\n    getListParent : function(el) {\n      while (el && !el.hasAttribute(\"data-simply-list\")) {\n        if (el.parentNode && (el.parentNode.nodeType == document.ELEMENT_NODE)) {\n          el = el.parentNode;\n        } else {\n          el = false;\n        }\n      }\n      return el;\n    },\n    getListItemParent : function(el) {\n      while (el && !el.hasAttribute(\"data-simply-list-item\")) {\n        if (el.parentNode && (el.parentNode.nodeType == document.ELEMENT_NODE)) {\n          el = el.parentNode;\n        } else {\n          el = false;\n        }\n      }\n      return el;\n    },\n    dragStart : function(event) {\n      var target = simply.dragdrop.getListItemParent(event.target);\n      var dataBinding = simply.dragdrop.getDataBinding(target);\n      localStorage.currentDragItem = dataBinding.config.parentKey;\n      localStorage.dragdrop = \"dragStart\";\n      document.currentDragItem = target;\n      // event.dataTransfer.effectAllowed = 'move';\n\n      event.dataTransfer.setData(\"application/json\", JSON.stringify(simply.dragdrop.getData(target), true));\n      var simplyType = \"simply/\" + target.parentNode.dataBinding.config.key.toLowerCase();\n      event.dataTransfer.setData(simplyType, \"1\");\n      event.dataTransfer.setDragImage(event.target, 0, 0);\n\n      return true;\n    },\n    dragEnter : function(event) {\n      var listParent = simply.dragdrop.getListParent(event.target);\n      if (listParent) {\n        listParent.classList.add(\"simply-dragdrop-receiving\");\n        event.preventDefault();\n        return true;\n      }\n    },\n    dragLeave : function(event) {\n      var listParent = simply.dragdrop.getListParent(event.target);\n      if (listParent) {\n        listParent.classList.remove(\"simply-dragdrop-receiving\");\n      }\n      event.preventDefault();\n      return true;\n    },\n    dragOver : function(event) {\n      var listParent = simply.dragdrop.getListParent(event.target);\n      if (listParent) {\n        const isJson = event.dataTransfer.types.includes(\"application/json\");\n        const expectedType = \"simply/\" + listParent.dataBinding.config.key.toLowerCase();\n        const isTypeAccepted = event.dataTransfer.types.includes(expectedType);\n        if (isJson && isTypeAccepted) {\n          event.preventDefault();\n        }\n      }\n    },\n    drop : function(event) {\n      var listParent = simply.dragdrop.getListParent(event.target);\n      var data = JSON.parse(event.dataTransfer.getData(\"application/json\"));\n\n      listParent.classList.remove(\"simply-dragdrop-receiving\");\n\n      const expectedType = \"simply/\" + listParent.dataBinding.config.key.toLowerCase();\n      const isTypeAccepted = event.dataTransfer.types.includes(expectedType);\n\n      if (listParent && isTypeAccepted) {\n        var data = JSON.parse(event.dataTransfer.getData(\"application/json\"));\n        event.preventDefault();\n        let dropEffect = event.dataTransfer.dropEffect;\n\n        switch (dropEffect) {\n          case \"move\":\n            localStorage.dragdrop = \"move\";\n            let sourceElement = document.currentDragItem;\n            if (sourceElement) {\n              sourceElement.remove();\n            }\n            break;\n          case \"copy\":\n          default:\n            // do nothing, leave the original item;\n            break;\n        }\n        listParent.dataBinding.get().push(data);\n        window.setTimeout(function() {\n          localStorage.currentDragItem = '';\n        }, 250);\n      }\n    }\n  };\n  window.addEventListener(\"storage\", function(event) {\n    if((event.key == \"dragdrop\") && (event.newValue == \"move\")) {\n      var currentDragItem = localStorage.currentDragItem;\n      var dataBinding = simply.dragdrop.getDataBinding(document.currentDragItem);\n      if (dataBinding && dataBinding.config.parentKey == localStorage.currentDragItem) {\n        document.currentDragItem.remove();\n      }\n      document.currentDragItem = false;\n    }\n  });\n  document.addEventListener(\"dragstart\", simply.dragdrop.dragStart);\n  document.addEventListener(\"dragenter\", simply.dragdrop.dragEnter);\n  document.addEventListener(\"dragleave\", simply.dragdrop.dragLeave);\n  document.addEventListener(\"dragover\", simply.dragdrop.dragOver);\n  document.addEventListener(\"drop\", simply.dragdrop.drop);\n</script>","validateResult":{"messages":[]}}]